@model List<Sarap.Models.VacacionesEmpleado>
@{
    ViewBag.Title = "Gestión de Vacaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="fas fa-umbrella-beach me-2"></i>Gestión de Vacaciones
        </h2>
    </div>

    <div class="card border-0 shadow-lg">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="card-title mb-0"><i class="fas fa-list-ol me-2"></i>Registro de Vacaciones</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Identidad</th>
                            <th>Empleado</th>
                            <th class="text-center">Disponibles</th>
                            <th class="text-center">Usados</th>
                            <th class="text-center">Saldo</th>
                            <th class="text-end pe-4">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var empleado in Model)
                        {
                            <tr>
                                <td class="ps-4 fw-semibold">@empleado.Identidad</td>
                                <td>@empleado.NombreCompleto</td>
                                <td class="text-center">
                                    <span class="badge bg-success rounded-pill">@(empleado.DiasDisponibles.HasValue? empleado.DiasDisponibles.Value : 0)</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info rounded-pill">@(empleado.DiasUsados.HasValue? empleado.DiasUsados.Value : 0)</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary rounded-pill">
                                        @{
                                            var saldo = (empleado.DiasDisponibles ?? 0) - (empleado.DiasUsados ?? 0);
                                        }
                                        @saldo
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-primary btn-solicitar"
                                            title="Solicitar días"
                                            data-id="@empleado.Id"
                                            data-identidad="@empleado.Identidad"
                                            data-nombre="@empleado.NombreCompleto"
                                            data-disponibles="@(empleado.DiasDisponibles ?? 0)">
                                        <i class="fas fa-plus me-1"></i>Solicitar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Solicitar Días -->
<div class="modal fade" id="solicitarDiasModal" tabindex="-1" aria-labelledby="solicitarDiasModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <form id="formSolicitarVacaciones">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="solicitarDiasModalLabel">
                        <i class="fas fa-calendar-plus me-2"></i>Solicitar Días de Vacaciones
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="empleadoId" name="id" />
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Empleado</label>
                        <input type="text" class="form-control" id="modalEmpleadoNombre" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="cantidadDias" class="form-label fw-semibold">Cantidad de días</label>
                        <input type="number" class="form-control" id="cantidadDias" name="cantidadDias" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="fechaInicio" class="form-label fw-semibold">Fecha de inicio</label>
                        <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" required>
                    </div>
                    <div class="mb-3">
                        <label for="comentarios" class="form-label fw-semibold">Comentarios</label>
                        <textarea class="form-control" id="comentarios" name="comentarios" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Enviar Solicitud
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Botones de solicitar
            const btnsSolicitar = document.querySelectorAll('.btn-solicitar');
            const modal = new bootstrap.Modal(document.getElementById('solicitarDiasModal'));
            const formSolicitar = document.getElementById('formSolicitarVacaciones');
            const modalEmpleadoNombre = document.getElementById('modalEmpleadoNombre');
            const inputEmpleadoId = document.getElementById('empleadoId');
            const inputCantidadDias = document.getElementById('cantidadDias');
            const inputFechaInicio = document.getElementById('fechaInicio');

            // Establecer fecha mínima para solicitud (hoy)
            const today = new Date().toISOString().split('T')[0];
            inputFechaInicio.min = today;

            btnsSolicitar.forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const nombre = this.getAttribute('data-nombre');
                    const disponibles = this.getAttribute('data-disponibles');

                    // Llenar el modal
                    modalEmpleadoNombre.value = nombre;
                    inputEmpleadoId.value = id;
                    inputCantidadDias.setAttribute('max', disponibles);
                    inputCantidadDias.value = '';
                    inputFechaInicio.value = '';
                    document.getElementById('comentarios').value = '';

                    // Mostrar el modal
                    modal.show();
                });
            });

            // Validar cantidad de días
            inputCantidadDias.addEventListener('change', function() {
                const max = parseInt(this.getAttribute('max'));
                if (parseInt(this.value) > max) {
                    alert(`No puede solicitar más de ${max} días disponibles`);
                    this.value = max;
                }
            });

            // Enviar formulario con AJAX
            formSolicitar.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);

                fetch('@Url.Action("Solicitar", "VacacionesEmpleado")', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Error en la solicitud');
                })
                .then(data => {
                    if (data.success) {
                        alert('Solicitud enviada correctamente');
                        modal.hide();
                        location.reload(); // Recargar para ver cambios
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al enviar la solicitud');
                });
            });
        });
    </script>
}